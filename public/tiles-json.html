<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mosaic Tile Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>

  <div class="p-6 bg-gray-100 min-h-screen">
    <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">
      Mosaic Tile Editor
    </h1>
    
    <div class="max-w-4xl mx-auto">
      <!-- Controls -->
      <div class="mb-6 bg-white p-4 rounded-lg shadow-md">
        <div class="flex flex-wrap items-center gap-4 mb-4">
          <div id="color-palette" class="flex flex-wrap gap-2">
            <!-- Colors will be generated by JS -->
          </div>
          
          <div class="flex flex-wrap gap-2">
            <button id="apply-color-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
              Apply Color (<span id="selected-count">0</span> selected)
            </button>
            
            <button id="clear-selection-btn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
              Clear Selection
            </button>
            
            <button id="export-json-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
              Export JSON
            </button>
            
            <button id="download-image-btn" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
              Download Image
            </button>
            <!-- Rotation Buttons -->
            <button id="rotate-left-btn" class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition-colors">
              ⟲
            </button>
            <button id="rotate-right-btn" class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition-colors">
              ⟳
            </button>
          </div>
        </div>
        
        <p class="text-sm text-gray-600">
          Click tiles to select them. Hold Shift/Ctrl/Cmd to select multiple tiles.
        </p>
      </div>

      <!-- Mosaic Grid -->
      <div class="p-4 rounded-lg shadow-lg inline-block mx-auto" style="background-color: #808080;">
        <div id="mosaic-grid" class="grid grid-cols-8 gap-1">
          <!-- Tiles will be generated by JS -->
        </div>
      </div>

      <!-- Selected Tiles Info -->
      <div id="selected-tiles-info" class="mt-6 bg-white p-4 rounded-lg shadow-md" style="display: none;">
        <h3 class="font-semibold mb-2">Selected Tiles (<span id="selected-info-count">0</span>):</h3>
        <div id="selected-tiles-list" class="text-sm text-gray-600 max-h-32 overflow-y-auto">
          <!-- List will be generated by JS -->
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- State ---
      let grid = [];
      let selectedColor = '#C85A5A';

      // --- DOM Elements ---
      const mosaicGrid = document.getElementById('mosaic-grid');
      const colorPalette = document.getElementById('color-palette');
      const applyColorBtn = document.getElementById('apply-color-btn');
      const selectedCountSpan = document.getElementById('selected-count');
      const clearSelectionBtn = document.getElementById('clear-selection-btn');
      const exportJsonBtn = document.getElementById('export-json-btn');
      const downloadImageBtn = document.getElementById('download-image-btn');
      const rotateLeftBtn = document.getElementById('rotate-left-btn');
      const rotateRightBtn = document.getElementById('rotate-right-btn');
      const selectedTilesInfo = document.getElementById('selected-tiles-info');
      const selectedInfoCountSpan = document.getElementById('selected-info-count');
      const selectedTilesList = document.getElementById('selected-tiles-list');

      const colors = [
        '#C85A5A', '#5A8A5A', '#B8A842', '#4A90E2', '#9B59B6',
        '#E67E22', '#2ECC71', '#F39C12', '#34495E', '#ECF0F1'
      ];

      // --- Initialization ---
      const initializeGrid = () => {
        const initialGrid = [];
        for (let row = 0; row < 8; row++) {
          const gridRow = [];
          for (let col = 0; col < 8; col++) {
            let color;
            if (row === 0) color = '#C85A5A';
            else if (row === 1) color = col < 4 ? '#B8A842' : '#C85A5A';
            else if (row >= 2 && row <= 6) {
              if (col < 2) color = '#5A8A5A';
              else if (col < 4) color = '#B8A842';
              else color = '#C85A5A';
            } else if (row === 7) color = '#C85A5A';
            gridRow.push({ x: col, y: row, color: color, selected: false });
          }
          initialGrid.push(gridRow);
        }
        grid = initialGrid;
      };

      // --- Rendering ---
      const renderGrid = () => {
        mosaicGrid.innerHTML = '';
        grid.forEach((row, rowIndex) => {
          row.forEach((tile, colIndex) => {
            const tileEl = document.createElement('div');
            tileEl.className = `w-12 h-12 cursor-pointer transition-all hover:opacity-80`;
            if (tile.selected) {
              tileEl.classList.add('ring-4', 'ring-yellow-400', 'ring-opacity-80', 'scale-105');
            }
            tileEl.style.backgroundColor = tile.color;
            tileEl.title = `Tile (${colIndex}, ${rowIndex}) - ${tile.color}`;
            tileEl.addEventListener('click', (e) => handleTileClick(rowIndex, colIndex, e));
            mosaicGrid.appendChild(tileEl);
          });
        });
        updateUI();
      };

      const renderColorPalette = () => {
        colorPalette.innerHTML = '';
        colors.forEach(color => {
          const colorBtn = document.createElement('button');
          colorBtn.className = 'w-8 h-8 rounded-full border-2 transition-all border-gray-300 hover:border-gray-500';
          if (selectedColor === color) {
            colorBtn.classList.remove('border-gray-300', 'hover:border-gray-500');
            colorBtn.classList.add('border-gray-800', 'scale-110');
          }
          colorBtn.style.backgroundColor = color;
          colorBtn.title = `Select ${color}`;
          colorBtn.addEventListener('click', () => {
            selectedColor = color;
            renderColorPalette();
          });
          colorPalette.appendChild(colorBtn);
        });
      };

      const updateUI = () => {
        const selectedTiles = getSelectedTiles();
        const count = selectedTiles.length;

        selectedCountSpan.textContent = count;
        applyColorBtn.disabled = count === 0;

        if (count > 0) {
          selectedTilesInfo.style.display = 'block';
          selectedInfoCountSpan.textContent = count;
          selectedTilesList.innerHTML = '';
          selectedTiles.forEach(tile => {
            const item = document.createElement('div');
            item.className = 'flex items-center gap-2 mb-1';
            item.innerHTML = `
              <div class="w-4 h-4 rounded border" style="background-color: ${tile.color};"></div>
              <span>(${tile.x}, ${tile.y}) - ${tile.color}</span>
            `;
            selectedTilesList.appendChild(item);
          });
        } else {
          selectedTilesInfo.style.display = 'none';
        }
      };

      // --- Logic & Event Handlers ---
      const getSelectedTiles = () => {
        const selected = [];
        grid.forEach(row => {
          row.forEach(tile => {
            if (tile.selected) selected.push(tile);
          });
        });
        return selected;
      };

      const handleTileClick = (rowIndex, colIndex, event) => {
        if (event.shiftKey || event.ctrlKey || event.metaKey) {
          grid[rowIndex][colIndex].selected = !grid[rowIndex][colIndex].selected;
        } else {
          grid.forEach(row => row.forEach(tile => tile.selected = false));
          grid[rowIndex][colIndex].selected = true;
        }
        renderGrid();
      };

      const handleColorChange = () => {
        grid.forEach(row => {
          row.forEach(tile => {
            if (tile.selected) tile.color = selectedColor;
          });
        });
        renderGrid();
      };

      const clearSelection = () => {
        grid.forEach(row => row.forEach(tile => tile.selected = false));
        renderGrid();
      };

      const getJSONData = () => {
        const allTiles = grid.flat().map(tile => ({ x: tile.x, y: tile.y, color: tile.color }));
        return { grid: allTiles, dimensions: { width: 8, height: 8 } };
      };

      const exportToJSON = () => {
        const jsonData = getJSONData();
        const jsonString = JSON.stringify(jsonData, null, 2);
        navigator.clipboard.writeText(jsonString)
          .then(() => alert('Mosaic data copied to clipboard!'))
          .catch(err => console.error('Failed to copy text: ', err));
      };

      const downloadImage = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const tileSize = 48;
        const gap = 4;
        const padding = 16;
        const canvasSize = (tileSize * 8) + (gap * 7) + (padding * 2);
        canvas.width = canvasSize;
        canvas.height = canvasSize;
        ctx.fillStyle = '#808080';
        ctx.fillRect(0, 0, canvasSize, canvasSize);
        grid.forEach((row, rowIndex) => {
          row.forEach((tile, colIndex) => {
            const x = padding + (colIndex * (tileSize + gap));
            const y = padding + (rowIndex * (tileSize + gap));
            ctx.fillStyle = tile.color;
            ctx.fillRect(x, y, tileSize, tileSize);
          });
        });
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'mosaic-tile-pattern.png';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 'image/png');
      };

      // --- Rotation Logic ---
      const rotateGridLeft = () => {
        // 90 deg left: newGrid[y][x] = grid[x][N-1-y]
        const N = grid.length;
        const M = grid[0].length;
        const newGrid = [];
        for (let col = M - 1; col >= 0; col--) {
          const newRow = [];
          for (let row = 0; row < N; row++) {
            // Deep copy tile and update coordinates
            const oldTile = grid[row][col];
            newRow.push({
              ...oldTile,
              x: M - 1 - col,
              y: row
            });
          }
          newGrid.push(newRow);
        }
        // Transpose to keep grid[y][x] structure
        grid = newGrid;
        // Fix x/y for all tiles
        grid.forEach((row, y) => row.forEach((tile, x) => { tile.x = x; tile.y = y; }));
        renderGrid();
      };

      const rotateGridRight = () => {
        // 90 deg right: newGrid[y][x] = grid[N-1-x][y]
        const N = grid.length;
        const M = grid[0].length;
        const newGrid = [];
        for (let col = 0; col < M; col++) {
          const newRow = [];
          for (let row = N - 1; row >= 0; row--) {
            // Deep copy tile and update coordinates
            const oldTile = grid[row][col];
            newRow.push({
              ...oldTile,
              x: col,
              y: N - 1 - row
            });
          }
          newGrid.push(newRow);
        }
        // Transpose to keep grid[y][x] structure
        grid = newGrid;
        // Fix x/y for all tiles
        grid.forEach((row, y) => row.forEach((tile, x) => { tile.x = x; tile.y = y; }));
        renderGrid();
      };

      // --- Attach Event Listeners ---
      applyColorBtn.addEventListener('click', handleColorChange);
      clearSelectionBtn.addEventListener('click', clearSelection);
      exportJsonBtn.addEventListener('click', exportToJSON);
      downloadImageBtn.addEventListener('click', downloadImage);
      rotateLeftBtn.addEventListener('click', rotateGridLeft);
      rotateRightBtn.addEventListener('click', rotateGridRight);

      // --- Initial Load ---
      initializeGrid();
      renderColorPalette();
      renderGrid();
    });
  </script>

</body>
</html>